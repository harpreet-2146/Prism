generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String         @id @default(uuid())
  email         String         @unique
  passwordHash  String         @map("password_hash")
  fullName      String?        @map("full_name")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  conversations Conversation[]
  documents     Document[]
  embeddings    Embedding[]
  refreshTokens RefreshToken[]

  @@index([email])
  @@map("users")
}

model Document {
  id              String          @id @default(uuid())
  userId          String          @map("user_id")
  filename        String
  originalName    String          @map("original_name")
  fileSize        Int             @map("file_size")
  mimeType        String          @map("mime_type")
  storagePath     String          @map("storage_path")
  sapModule       String?         @map("sap_module")
  tcodes          String[]        @default([])
  errorCodes      String[]        @default([]) @map("error_codes")
  noteNumber      String?         @map("note_number")
  status          String          @default("pending")
  processingError String?         @map("processing_error")
  textContent     String?         @map("text_content")
  pageCount       Int             @default(0) @map("page_count")
  imageCount      Int             @default(0) @map("image_count")
  embeddingStatus String          @default("pending") @map("embedding_status")
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")
  images          DocumentImage[]
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  embeddings      Embedding[]

  @@index([userId])
  @@index([status])
  @@index([sapModule])
  @@map("documents")
}

model DocumentImage {
  id            String      @id @default(uuid())
  documentId    String      @map("document_id")
  pageNumber    Int         @map("page_number")
  imageIndex    Int         @map("image_index")
  storagePath   String      @map("storage_path")
  width         Int
  height        Int
  format        String
  fileSize      Int         @map("file_size")
  createdAt     DateTime    @default(now()) @map("created_at")
  ocrText       String?     @map("ocr_text")
  ocrConfidence Float?      @map("ocr_confidence")
  ocrLanguage   String?     @default("eng") @map("ocr_language")
  ocrStatus     String      @default("pending") @map("ocr_status")
  document      Document    @relation(fields: [documentId], references: [id], onDelete: Cascade)
  embeddings    Embedding[]

  @@index([documentId])
  @@index([pageNumber])
  @@index([ocrStatus])
  @@map("document_images")
}

model Embedding {
  id            String         @id @default(uuid())
  documentId    String         @map("document_id")
  userId        String         @map("user_id")
  chunkIndex    Int            @map("chunk_index")
  pageNumber    Int            @default(1) @map("page_number")
  text          String
  embedding     Json
  createdAt     DateTime       @default(now()) @map("created_at")
  sourceType    String         @map("source_type")
  sourceImageId String?        @map("source_image_id")
  document      Document       @relation(fields: [documentId], references: [id], onDelete: Cascade)
  sourceImage   DocumentImage? @relation(fields: [sourceImageId], references: [id], onDelete: Cascade)
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([userId])
  @@index([sourceType])
  @@index([sourceImageId])
  @@map("embeddings")
}

model Conversation {
  id            String    @id @default(uuid())
  userId        String    @map("user_id")
  title         String    @default("New Chat")
  documentsUsed String[]  @default([]) @map("documents_used")
  totalMessages Int       @default(0) @map("total_messages")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages      Message[]

  @@index([userId])
  @@index([createdAt])
  @@map("conversations")
}

model Message {
  id             String       @id @default(uuid())
  conversationId String       @map("conversation_id")
  role           String
  content        String
  sources        Json?
  steps          Json?
  diagrams       Json?
  images         Json?
  tokensUsed     Int?         @map("tokens_used")
  createdAt      DateTime     @default(now()) @map("created_at")
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
  @@map("messages")
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("refresh_tokens")
}
