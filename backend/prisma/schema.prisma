// backend/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ================================================================
// USERS
// ================================================================
model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  fullName     String?  @map("full_name")

  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  documents     Document[]
  conversations Conversation[]
  embeddings    Embedding[]
  refreshTokens RefreshToken[]

  @@map("users")
  @@index([email])
}

// ================================================================
// DOCUMENTS (uploaded PDFs)
// ================================================================
model Document {
  id           String  @id @default(uuid())
  userId       String  @map("user_id")

  filename     String
  originalName String  @map("original_name")
  fileSize     Int     @map("file_size")
  mimeType     String  @map("mime_type")
  storagePath  String  @map("storage_path")

  // SAP metadata auto-detected from PDF text
  sapModule    String?  @map("sap_module")
  tcodes       String[] @default([])
  errorCodes   String[] @default([]) @map("error_codes")
  noteNumber   String?  @map("note_number")

  // Processing status: pending | processing | completed | failed
  status          String  @default("pending")
  processingError String? @map("processing_error")

  // Extracted content
  textContent String? @db.Text @map("text_content")
  pageCount   Int     @default(0) @map("page_count")
  imageCount  Int     @default(0) @map("image_count")

  // Embedding status: pending | processing | completed | failed
  embeddingStatus String @default("pending") @map("embedding_status")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user       User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  images     DocumentImage[]
  embeddings Embedding[]

  @@map("documents")
  @@index([userId])
  @@index([status])
  @@index([sapModule])
}

// ================================================================
// DOCUMENT IMAGES (PDF pages rendered as JPEG/PNG images)
// ================================================================
model DocumentImage {
  id          String @id @default(uuid())
  documentId  String @map("document_id")

  pageNumber  Int    @map("page_number")
  imageIndex  Int    @map("image_index")
  storagePath String @map("storage_path")

  width    Int
  height   Int
  format   String
  fileSize Int    @map("file_size")

  createdAt DateTime @default(now()) @map("created_at")

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@map("document_images")
  @@index([documentId])
  @@index([pageNumber])
}

// ================================================================
// EMBEDDINGS
// Replaces Milvus. 384-float arrays stored as JSON in PostgreSQL.
// Cosine similarity is computed in JavaScript at query time.
// Source model: sentence-transformers/all-MiniLM-L6-v2 via HF API
// ================================================================
model Embedding {
  id         String @id @default(uuid())
  documentId String @map("document_id")
  userId     String @map("user_id")

  chunkIndex Int    @map("chunk_index")
  pageNumber Int    @default(1) @map("page_number")
  text       String @db.Text

  // Stored as JSON array: [0.123, -0.456, 0.789, ...]
  embedding Json

  createdAt DateTime @default(now()) @map("created_at")

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("embeddings")
  @@index([documentId])
  @@index([userId])
}

// ================================================================
// CONVERSATIONS
// ================================================================
model Conversation {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  title         String   @default("New Chat")
  documentsUsed String[] @default([]) @map("documents_used")
  totalMessages Int      @default(0) @map("total_messages")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages Message[]

  @@map("conversations")
  @@index([userId])
  @@index([createdAt])
}

// ================================================================
// MESSAGES
// ================================================================
model Message {
  id             String @id @default(uuid())
  conversationId String @map("conversation_id")

  // 'user' or 'assistant'
  role    String
  content String @db.Text

  // All nullable â€” only populated on assistant messages
  // sources:  [{type, id, title, pageNumber}]
  sources  Json?
  // steps:    [{title, description, tcode, imageUrl, screenshotDescription}]
  steps    Json?
  // diagrams: mermaid code string
  diagrams Json?
  // images:   [{url, source, pageNumber, documentId}]
  images   Json?

  tokensUsed Int? @map("tokens_used")

  createdAt DateTime @default(now()) @map("created_at")

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@map("messages")
  @@index([conversationId])
  @@index([createdAt])
}

// ================================================================
// REFRESH TOKENS
// ================================================================
model RefreshToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}
